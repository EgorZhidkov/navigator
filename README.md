# GeoIndexService

Сервис для индексации и поиска географических объектов, связанных с ракетно-космической отраслью России.

## Архитектура

Сервис состоит из следующих компонентов:

- **PostgreSQL** - основное хранилище данных с поддержкой геопространственных запросов
- **Kafka** - брокер сообщений для передачи данных между компонентами
- **Redis** - быстрый кэш с поддержкой геопространственного индекса
- **postgres-to-kafka** - сервис для отслеживания изменений в PostgreSQL и отправки их в Kafka
- **kafka-to-redis** - сервис для получения данных из Kafka и сохранения их в Redis

## Установка и запуск

### Предварительные требования

- Docker и Docker Compose
- Node.js (для запуска скриптов импорта данных)

### Шаги для запуска

1. Скопируйте проект на новый компьютер
2. Запустите контейнеры:
   ```bash
   docker compose up --build -d
   ```
3. Импортируйте типы объектов:
   ```bash
   node data/import_place_types.js
   ```
4. Импортируйте сами объекты:
   ```bash
   node data/import_places.js
   ```

### Важные моменты

- В файле `docker-compose.yml` указаны порты для PostgreSQL (5432), Redis (6379) и Kafka (9092). Убедитесь, что эти порты свободны
- В скриптах импорта (`import_places.js` и `import_place_types.js`) указаны параметры подключения к PostgreSQL. Если они отличаются на новом компьютере, их нужно будет изменить

## Добавление новых данных

Новые данные можно добавлять двумя способами:

1. Через скрипт импорта (`import_places.js`), добавив новые объекты в файл `places.json`
2. Напрямую в базу данных PostgreSQL через SQL-запросы

### Пример добавления данных через SQL

```sql
INSERT INTO places (name, description, coordinates, type_id, opening_hours)
VALUES (
    'Название объекта',
    'Описание объекта',
    ST_SetSRID(ST_MakePoint(долгота, широта), 4326),
    id_типа,
    '09:00-18:00'
);
```

### Что происходит при добавлении новых данных

1. При добавлении данных в PostgreSQL срабатывает триггер `places_changes_trigger`
2. Триггер отправляет уведомление через `pg_notify`
3. Сервис `postgres-to-kafka` получает уведомление и отправляет данные в Kafka
4. Сервис `kafka-to-redis` получает данные из Kafka и сохраняет их в Redis

## Использование

После запуска сервиса вы можете:

1. Искать объекты по радиусу через Redis:
   ```bash
   docker exec geoindexservice-redis-1 redis-cli GEORADIUS places:geo долгота широта радиус км
   ```

2. Получать информацию об объекте:
   ```bash
   docker exec geoindexservice-redis-1 redis-cli HGETALL place:ID
   ```

3. Выполнять геопространственные запросы в PostgreSQL:
   ```sql
   SELECT * FROM places 
   WHERE ST_DWithin(coordinates, ST_SetSRID(ST_MakePoint(долгота, широта), 4326), радиус_в_метрах);
   ```

## Типы объектов

Сервис поддерживает следующие типы объектов:

1. Космодром
2. Музей
3. Исследовательский центр
4. Завод
5. Исторический объект
6. Учебное заведение
7. Памятник
8. Центр управления полетами
9. Испытательный полигон
10. Образовательный центр

Каждый объект имеет:
- Название
- Описание
- Координаты (долгота и широта)
- Тип
- Часы работы

## Функциональность

- Хранение информации о местах в PostgreSQL с поддержкой PostGIS
- Автоматическая синхронизация изменений с Redis через Kafka
- Быстрый поиск мест по координатам с использованием Redis GEO
- REST API для работы с местами

## Запуск

```bash
docker compose up --build -d
```

## API Endpoints

### Places

- `GET /places` - получение списка мест
- `GET /places/{id}` - получение информации о месте
- `POST /places` - создание нового места
- `PUT /places/{id}` - обновление информации о месте
- `DELETE /places/{id}` - удаление места

### Geo Search

- `GET /places/nearby?lat={latitude}&lon={longitude}&radius={radius}` - поиск мест в радиусе от заданной точки

## Мониторинг

- Redis Commander: http://localhost:8081
- Kafka UI: http://localhost:8080 